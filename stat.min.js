/*!
 * Statistique 
 * Version: 1.1 30/01/23 
 *
 * Copyright (c) 2019 - 2023 ALL RIGHTS RESERVED
 * auteur Mickael FEUVRIER
 * 
*/
$(()=>{const W_HEIGHT=$(window).height();$("<div />").attr("id","drawer").appendTo("#stat"),$("<div />").attr("id","toolbar").appendTo("#drawer"),$("<div />").attr("id","stat-wrapper").appendTo("#drawer").height(W_HEIGHT-80),$("<div />").attr("id","pivotgrid-ca-by-an").appendTo("#stat-wrapper"),$("<div />").attr("id","pivotgrid-ca-by-type").appendTo("#stat-wrapper"),$("<div />").attr("id","chart-ca-by-an-wrapper").addClass("chart-flex1").appendTo("#stat-wrapper"),$("<div />").attr("id","chart-ca-by-type-wrapper").appendTo("#stat-wrapper"),$("<div />").attr({id:"chart-ca-by-an","data-options":"dxItem:{ratio:1}"}).appendTo("#chart-ca-by-an-wrapper").addClass("chart1"),$("<div />").attr({id:"chart-ca-by-type-bar","data-options":"dxItem:{ratio:1}"}).appendTo("#chart-ca-by-type-wrapper").addClass("chart"),$("<div />").attr("id","loader").appendTo("#stat");let dataDownloaded=[];const TYPE_OF_FACTURE=[{id:0,text:"Ponctuel et Annuel"},{id:1,text:"Annuel"},{id:2,text:"Ponctuel"}];Globalize.locale(navigator.language);const DE_FORMATTER=Globalize("fr").currencyFormatter("EUR");class queryFM{constructor(script,param){this.script=script,this.param=param}}const FACTURE_STORE=new DevExpress.data.ArrayStore({name:"data",key:"id"}),FACTURE_SOURCE=new DevExpress.data.DataSource({store:FACTURE_STORE,paginate:!1,reshapeOnPush:!0}),DRAWER=$("#drawer").dxDrawer({opened:!0,height:W_HEIGHT,elementAttr:{class:"drawer-stat"},width:"100%",closeOnOutsideClick:!1,openedStateMode:"shrink",template:()=>{const WRAPPER_PANEL=$("<div />").addClass("panel-content").width("250px");return WRAPPER_PANEL.append($("<div />").attr("id","form-options")),WRAPPER_PANEL},onOptionChanged:()=>{let buttonPanel=$(".buttonPanel");buttonPanel.hasClass("panelOpened")?buttonPanel.removeClass("panelOpened"):buttonPanel.addClass("panelOpened")}}).dxDrawer("instance"),FORM_OPTIONS=$("#form-options").dxForm({items:[{itemType:"group",cssClass:"group-year",colCount:3,caption:"Année",name:"group_year",items:[{dataField:"year",itemType:"numberBox",cssClass:"an-select",name:"year",label:{visible:!1},editorOptions:{value:getYear()-2,showSpinButtons:!0,width:70,height:25,min:2010,max:getYear(),onValueChanged(e){e.value?getDataFacture(e.value):e.value}}},{dataField:"year1",itemType:"numberBox",cssClass:"an-select",label:{visible:!1},editorOptions:{value:getYear()-1,showSpinButtons:!0,width:70,height:25,min:2010,max:getYear(),onValueChanged(e){e.value?getDataFacture(e.value):e.value}}},{dataField:"year2",itemType:"numberBox",cssClass:"an-select",label:{visible:!1},editorOptions:{value:getYear(),showSpinButtons:!0,width:70,height:25,min:2010,max:getYear(),onValueChanged(e){e.value?getDataFacture(e.value):e.value}}}]},{itemType:"group",cssClass:"group-type",caption:"type",name:"type",items:[{dataField:"type_fct",editorType:"dxRadioGroup",label:{visible:!1},editorOptions:{items:TYPE_OF_FACTURE,valueExpr:"id",value:0,displayExpr:"text",onValueChanged:function(e){PIVOTGRID_CA_BY_AN.option("dataSource.store",getMyData())}}}]},{itemType:"group",cssClass:"group-val-mens",colCount:1,caption:"options",name:"options",items:[{dataField:"val_mens",itemType:"checkBox",label:{visible:!1},editorOptions:{value:!0,text:"valeurs mensuels",onValueChanged:function(e){getColumnVisible(2);const ARRAY_EDITOR_MENS=["val_mens_dif","val_mens_dif_perc","val_mens_dif2","val_mens_dif_perc2"];e.value?($.each(ARRAY_EDITOR_MENS,(function(i,elem){FORM_OPTIONS.getEditor(`${elem}`).option("disabled",!1)})),colCountField(e)):($.each(ARRAY_EDITOR_MENS,(function(i,elem){FORM_OPTIONS.getEditor(`${elem}`).option("disabled",!0)})),colCountField(e))}}},{dataField:"val_mens_dif",itemType:"checkBox",name:"val_mens_dif",label:{visible:!1},editorOptions:{value:!1,text:"différence n et n-1",onValueChanged:function(e){getColumnVisible(3)}}},{dataField:"val_mens_dif_perc",itemType:"checkBox",name:"val_mens_dif_perc",label:{visible:!1},editorOptions:{value:!1,text:"différence n et n-1 %",onValueChanged:function(e){getColumnVisible(4)}}},{dataField:"val_mens_dif2",itemType:"checkBox",name:"val_mens_dif2",label:{visible:!1},editorOptions:{value:!1,text:"différence n et n-2",onValueChanged:function(e){getColumnVisible(5)}}},{dataField:"val_mens_dif_perc2",itemType:"checkBox",name:"val_mens_dif_perc2",label:{visible:!1},editorOptions:{value:!1,text:"différence n et n-2 %",onValueChanged:function(e){getColumnVisible(6)}}},{dataField:"val_cumul",itemType:"checkBox",name:"val_cumul",label:{visible:!1},editorOptions:{value:!1,text:"valeurs mensuels cumulées",onValueChanged:function(e){getColumnVisible(7);const ARRAY_EDITOR_CUMUL=["val_cumul_dif","val_cumul_dif_perc","val_cumul_dif2","val_cumul_dif_perc2"];e.value?($.each(ARRAY_EDITOR_CUMUL,(function(i,elem){FORM_OPTIONS.getEditor(`${elem}`).option("disabled",!1)})),colCountField(e)):($.each(ARRAY_EDITOR_CUMUL,(function(i,elem){FORM_OPTIONS.getEditor(`${elem}`).option("disabled",!0)})),colCountField(e))}}},{dataField:"val_cumul_dif",itemType:"checkBox",name:"val_cumul_dif",label:{visible:!1},editorOptions:{value:!1,text:"diff cumul n-1",onValueChanged:function(e){getColumnVisible(8)}}},{dataField:"val_cumul_dif_perc",itemType:"checkBox",name:"val_cumul_dif_perc",label:{visible:!1},editorOptions:{value:!1,text:"diff cumul n-1 %",onValueChanged:function(e){getColumnVisible(9)}}},{dataField:"val_cumul_dif2",itemType:"checkBox",name:"val_cumul_dif2",label:{visible:!1},editorOptions:{value:!1,text:"diff cumul n-2",onValueChanged:function(e){getColumnVisible(10)}}},{dataField:"val_cumul_dif_perc2",itemType:"checkBox",name:"val_cumul_dif_perc2",label:{visible:!1},editorOptions:{value:!1,text:"diff cumul n-2 %",onValueChanged:function(e){getColumnVisible(11)}}}]},{itemType:"group",cssClass:"group-reconnexion",colCount:1,caption:"",name:"group_reconnexion",items:[{name:"button_reconnexion",label:{visible:!1},editorType:"dxButton",editorOptions:{icon:"user",text:"",type:"normal",hint:"Reconnexion",elementAttr:{class:"button-reconnexion"},onClick:()=>{queryToFM(new queryFM("Reconnexion",""))}}}]}],onContentReady:function(e){const ARRAY_EDITOR_MENS=["val_mens_dif","val_mens_dif_perc","val_mens_dif2","val_mens_dif_perc2"],ARRAY_EDITOR_CUMUL=["val_cumul_dif","val_cumul_dif_perc","val_cumul_dif2","val_cumul_dif_perc2"];!1===e.component.getEditor("val_mens").option("value")&&$.each(ARRAY_EDITOR_MENS,(function(i,elem){e.component.getEditor(`${elem}`).option("disabled",!0)})),!1===e.component.getEditor("val_cumul").option("value")&&$.each(ARRAY_EDITOR_CUMUL,(function(i,elem){e.component.getEditor(`${elem}`).option("disabled",!0)}))}}).dxForm("instance");$("#toolbar").dxToolbar({height:"50px",items:[{widget:"dxButton",location:"before",options:{elementAttr:{class:"stat-menu-icon"},icon:"menu",onClick(){DRAWER.toggle()}}}]});const CHART_CA_BY_AN=$("#chart-ca-by-an").dxChart({palette:"Violet",commonAxisSettings:{label:{font:{size:10}}},scrollbar:{visible:!0},zoomAndPan:{argumentAxis:"both",valueAxis:"both"},legend:{columnCount:1},commonSeriesSettings:{type:"bar",argumentField:"arg",valueField:"val"},tooltip:{enabled:!0,format:"currency",currency:"EUR",customizeTooltip(args){let valueText="currency"==args.point.tag.type?Globalize.formatCurrency(args.originalValue,"EUR",{maximumFractionDigits:0}):args.originalValue,month;return{html:`${args.argument.replace(" | CA","")} ${args.seriesName}<div class='currency'>${valueText}</div>`}}},size:{height:300},adaptiveLayout:{width:450}}).dxChart("instance"),CHART_CA_BY_TYPE_BAR=$("#chart-ca-by-type-bar").dxChart({palette:"Violet",commonAxisSettings:{label:{font:{size:10}}},zoomAndPan:{argumentAxis:"both",valueAxis:"both"},commonSeriesSettings:{type:"stackedBar",label:{visible:!0,customizeText:args=>`${args.percentText}`}},title:{text:"pourcentage entre annuel et ponctuel"},tooltip:{enabled:!0,format:"currency",currency:"EUR",customizeTooltip(args){let valueText=Globalize.formatCurrency(args.originalValue,"EUR",{maximumFractionDigits:0}),percentText=args.percentText,an;return{html:`${args.argument.replace(" | CA","")} ${args.seriesName}<div class='currency'>${valueText}</div><div class='percent'>${percentText}</div>`}}},size:{height:300},adaptiveLayout:{width:450}}).dxChart("instance"),PIVOTGRID_CA_BY_AN=$("#pivotgrid-ca-by-an").dxPivotGrid({allowSortingBySummary:!0,allowFiltering:!0,allowEpandAll:!0,showBorders:!0,showColumnGrandTotals:!1,showRowGrandTotals:!0,showRowTotals:!1,showColumnTotals:!1,fieldChooser:{enabled:!1},texts:{grandTotal:"Total"},dataSource:{store:getMyData(),fields:[{area:"column",dataField:"date",dataType:"date",groupInterval:"year",expanded:!0},{area:"row",dataField:"date",dataType:"date",groupInterval:"month",sortBySummaryField:"month"},{visible:!0,caption:"Mensuel",dataField:"ht",dataType:"number",summaryType:"sum",format:{type:"currency",precision:2,currency:"EUR"},area:"data"},{visible:!1,caption:"diff n-1",dataType:"number",dataField:"ht",summaryType:"custom",format:{type:"currency",precision:2,currency:"EUR"},area:"data",allowCrossGroupCalculation:!1,calculateSummaryValue:function(e){let prev=e.prev(),htValue=e.value("ht");if(prev){const VAL=htValue-prev.value("ht");return VAL}},customizeText:function(e){if(e.value)return DE_FORMATTER(e.value)}},{visible:!1,caption:"diff n-1 %",dataType:"number",dataField:"ht",summaryType:"custom",format:{type:"percent",precision:2},area:"data",calculateSummaryValue:function(e){var prev=e.prev();if(prev)var prevht=prev.value("ht"),value=(e.value("ht")-prevht)/prevht;return value},allowCrossGroupCalculation:!1},{visible:!1,caption:"diff n-2",dataType:"number",dataField:"ht",summaryType:"custom",format:{type:"currency",precision:2},area:"data",allowCrossGroupCalculation:!1,calculateSummaryValue:function(e){var prev=e.prev(),nMoin;if(prev&&prev.prev())var nMoinVal,prevht=prev.prev().value("ht"),value=e.value("ht")-prevht;return value},customizeText:function(e){if(e.value)return DE_FORMATTER(e.value)}},{visible:!1,caption:"diff n-2 %",dataType:"number",dataField:"ht",summaryType:"custom",format:{type:"percent",precision:2},area:"data",calculateSummaryValue:function(e){var prev=e.prev(),nMoin;if(prev&&prev.prev())var nMoinVal,prevht=prev.prev().value("ht"),value=(e.value("ht")-prevht)/prevht;return value},allowCrossGroupCalculation:!1},{visible:!1,caption:"Cumul",dataField:"ht",dataType:"number",summaryType:"sum",runningTotal:"column",format:{type:"currency",precision:2,currency:"EUR"},area:"data"},{visible:!1,caption:"diff cumul n-1",dataType:"number",dataField:"ht",summaryType:"custom",runningTotal:"column",format:{type:"currency",precision:2,currency:"EUR"},area:"data",allowCrossGroupCalculation:!0,calculateSummaryValue:function(e){let prev=e.prev();if(prev){const VAL=e.value("ht")-prev.value("ht");return VAL}},customizeText:function(e){if(e.value)return DE_FORMATTER(e.value)}},{visible:!1,caption:"diff cumul n-1 %",dataType:"number",dataField:"ht",summaryType:"custom",format:{type:"percent",precision:2},area:"data",calculateSummaryValue:e=>{let val=e.value("ht"),prev=e.prev("row");if(prev)do{val+=prev.value("ht"),prev=prev.prev("row")}while(prev);let e_n=e.prev();if(e_n){let val_n=e_n.value("ht"),prev=e_n.prev("row");if(prev)do{val_n+=prev.value("ht"),prev=prev.prev("row")}while(prev);return(val-val_n)/val_n}}},{visible:!1,caption:"diff cumul n-2",dataType:"number",dataField:"ht",summaryType:"custom",runningTotal:"column",format:{type:"currency",precision:2,currency:"EUR"},area:"data",calculateSummaryValue:function(e){let prev=e.prev();if(prev){let e_n2=prev.prev();if(e_n2){const VAL=e.value("ht")-e_n2.value("ht");return VAL}}},customizeText:function(e){if(e.value)return DE_FORMATTER(e.value)}},{visible:!1,caption:"diff cumul n-2 %",dataType:"number",dataField:"ht",summaryType:"custom",format:{type:"percent",precision:2},area:"data",calculateSummaryValue:e=>{let val=e.value("ht"),prev=e.prev("row");if(prev)do{val+=prev.value("ht"),prev=prev.prev("row")}while(prev);let e_n=e.prev();if(e_n){let e_n2=e_n.prev();if(e_n2){let val_n=e_n2.value("ht"),prev=e_n2.prev("row");if(prev)do{val_n+=prev.value("ht"),prev=prev.prev("row")}while(prev);return(val-val_n)/val_n}}}}]},onCellPrepared(e){const cell=e.cell;if(cell.area=e.area,isDataCell(cell)||isTotalCell(cell)){const appearance=getConditionalAppearance(cell);Object.assign(e.cellElement.get(0).style,getCssStyles(appearance))}},export:{enabled:!0},onExporting(e){const workbook=new ExcelJS.Workbook,worksheet=workbook.addWorksheet("CA");DevExpress.excelExporter.exportPivotGrid({component:e.component,worksheet:worksheet,customizeCell:options=>{let{gridCell:gridCell,excelCell:excelCell}=options;console.log(excelCell),excelCell.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}}).then(()=>{workbook.xlsx.writeBuffer().then(buffer=>{saveAs(new Blob([buffer],{type:"application/octet-stream"}),"CA.xlsx")})}),e.cancel=!0}}).dxPivotGrid("instance"),PIVOTGRID_CA_BY_TYPE=$("#pivotgrid-ca-by-type").dxPivotGrid({visible:!1,allowSortingBySummary:!0,allowFiltering:!0,allowEpandAll:!0,showBorders:!0,showColumnGrandTotals:!1,showRowGrandTotals:!1,showRowTotals:!1,showColumnTotals:!1,fieldChooser:{enabled:!0},texts:{grandTotal:"Total"},dataSource:{store:getMyData(),fields:[{area:"column",dataField:"type",dataType:"text",expanded:!0},{area:"row",dataField:"date",dataType:"date",groupInterval:"year"},{caption:"ht",dataField:"ht",dataType:"number",summaryType:"sum",format:{type:"currency",precision:2,currency:"EUR"},area:"data"}]}}).dxPivotGrid("instance"),LOADER=$("#loader").dxLoadPanel({shadingColor:"rgba(0,0,0,0.4)",message:"Chargement des données...",visible:!1,showIndicator:!0,showPane:!1,shading:!0,hideOnOutsideClick:!1}).dxLoadPanel("instance");function getDataFacture(an){return dataDownloaded.includes(an)?afterFactureInStore():(dataDownloaded.push(an),queryToFM(new queryFM("getData",an))),!0}function queryToFM(query){return FileMaker.PerformScript(query.script,query.param),!0}function afterFactureInStore(){setTimeout(()=>PIVOTGRID_CA_BY_AN.option("dataSource.store",getMyData())),setTimeout(()=>PIVOTGRID_CA_BY_TYPE.option("dataSource.store",getMyData()))}function isDataCell(cell){return"data"===cell.area&&"D"===cell.rowType&&"D"===cell.columnType}function isTotalCell(cell){return"T"===cell.type||"GT"===cell.type||"T"===cell.rowType||"GT"===cell.rowType||"T"===cell.columnType||"GT"===cell.columnType}function getCssStyles(appearance){return{color:`#${appearance.font}`,"font-weight":appearance.bold?"bold":void 0,"border-color":`#${appearance.border}`}}function getConditionalAppearance(cell){if(isTotalCell(cell)){let cssCell={fill:"7d7a7a",bold:!0};return cell.value<0&&(cssCell.font="bf676a"),cssCell}return cell.value<0?{font:"bf676a"}:{font:"929292"}}function colCountField(e){let colSeries=1;e.value?colSeries+=1:colSeries-=1,CHART_CA_BY_AN.option("legend.columnCount",colSeries)}function getMyData(){let myData,FILTER_FACTURE_SOURCE;const IS_TYPE=TYPE_OF_FACTURE.find(type=>type.id==FORM_OPTIONS.getEditor("type_fct").option("value"));return FILTER_FACTURE_SOURCE=0==FORM_OPTIONS.getEditor("type_fct").option("value")?[["an","=",FORM_OPTIONS.getEditor("year").option("value")],"or",["an","=",FORM_OPTIONS.getEditor("year1").option("value")],"or",["an","=",FORM_OPTIONS.getEditor("year2").option("value")]]:[["type","contains",IS_TYPE.text],"and",[["an","=",FORM_OPTIONS.getEditor("year").option("value")],"or",["an","=",FORM_OPTIONS.getEditor("year1").option("value")],"or",["an","=",FORM_OPTIONS.getEditor("year2").option("value")]]],FACTURE_SOURCE.filter(FILTER_FACTURE_SOURCE),FACTURE_SOURCE.load().done(result=>{myData=result}),myData}function getColumnVisible(e){let val=!PIVOTGRID_CA_BY_AN.option(`dataSource.fields[${e}].visible`);if(PIVOTGRID_CA_BY_AN.option(`dataSource.fields[${e}].visible`,val),2!=e&&7!=e||val){if(2==e&&val){const ARRAY_EDITOR_MENS=["val_mens_dif","val_mens_dif_perc","val_mens_dif2","val_mens_dif_perc2"];$.each(ARRAY_EDITOR_MENS,(function(i,elem){let columnVisible;if(FORM_OPTIONS.getEditor(`${elem}`).option("value")){let columnIndex=e+i+1;PIVOTGRID_CA_BY_AN.option(`dataSource.fields[${columnIndex}].visible`,val)}}))}else if(7==e&&val){const ARRAY_EDITOR_CUMUL=["val_cumul_dif","val_cumul_dif_perc","val_cumul_dif2","val_cumul_dif_perc2"];$.each(ARRAY_EDITOR_CUMUL,(function(i,elem){let columnVisible;if(FORM_OPTIONS.getEditor(`${elem}`).option("value")){let columnIndex=e+i+1;PIVOTGRID_CA_BY_AN.option(`dataSource.fields[${columnIndex}].visible`,val)}}))}}else for(let i=1;i<5;i++){let columnIndex=e+i;PIVOTGRID_CA_BY_AN.option(`dataSource.fields[${columnIndex}].visible`,val)}}function getYear(){let nowDate,year;return(new Date).getFullYear()}$("#stat-wrapper").dxScrollView({useNative:!1,showScrollbar:"onScroll"}).dxScrollView("instance"),$(".dx-drawer-panel-content").dxScrollView({useNative:!1,showScrollbar:"onScroll"}).dxScrollView("instance"),getDataFacture(getYear()),getDataFacture(getYear()-1),getDataFacture(getYear()-2),PIVOTGRID_CA_BY_AN.bindChart(CHART_CA_BY_AN,{inverted:!0,putDataFieldsInto:"args",alternateDataFields:!1,processCell:function(cellData){let arr=["Total","Total | Mensuel","Total | Cumul","n-1","n-2","n-1 %","n-2 %"];if(FORM_OPTIONS.getEditor("val_cumul").option("value")||arr.push("| Cumul"),FORM_OPTIONS.getEditor("val_mens").option("value")||arr.push("| Mensuel"),arr.find(e=>{cellData.chartDataItem.arg.includes(e)&&(cellData.visible=!1)}),cellData.chartDataItem.arg.includes("Cumul")){let series,newSeries=`${cellData.chartDataItem.series} Cumul`;cellData.chartDataItem.series=newSeries;let newArg=cellData.chartDataItem.arg.replace(" | Cumul","");cellData.chartDataItem.arg=newArg}else{let series,newSeries=`${cellData.chartDataItem.series} Mensuel`;cellData.chartDataItem.series=newSeries;let newArg=cellData.chartDataItem.arg.replace(" | Mensuel","");cellData.chartDataItem.arg=newArg}if(cellData.chartDataItem.val){let format=cellData.dataFields[cellData.dataIndex].format;cellData.chartDataItem.tag=format}},customizeSeries:function(e,f){if(e.includes("Cumul"))return f.type="line",f}}),PIVOTGRID_CA_BY_TYPE.bindChart(CHART_CA_BY_TYPE_BAR,{inverted:!0,putDataFieldsInto:"args",processCell:function(cellData){if(arr=["Total","Total | Mensuel","Total | Cumul","| Mensuel","n-1","n-2","n-1 %","n-2 %"],arr.find(e=>{cellData.chartDataItem.arg.includes(e)&&(cellData.visible=!1)}),cellData.chartDataItem.val){var format=cellData.dataFields[cellData.dataIndex].format;cellData.chartDataItem.tag=format}}}),setData=val=>{const VAL=JSON.parse(val),EXPR=VAL.store,DATA_STORE=[{store:FACTURE_STORE,event:{name:"data",callback:afterFactureInStore}}];let arr=$.grep(DATA_STORE,(function(n,i){let result;return n.event.name==EXPR})),store=arr[0].store;const DATA=VAL.data;let func;DATA.forEach((e,i)=>{store.push([{type:"insert",data:e,index:i}])}),(0,arr[0].event.callback)()}});